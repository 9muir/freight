<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>freight-add</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>freight-add</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><p>Add a package to the Freight library.</p>

</pre></div></td></tr><tr><td class=docs>

<p>Combined usage message and help screen.</p>

</td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/sh</span>


<span class="nb">set</span> -e

</pre></div></td></tr><tr><td class=docs>

<p><code>getopts</code> doesn't support long options so this will have to do.</p>

</td><td class=code><div class=highlight><pre>
usage<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Usage: $(basename $0) [-k] [-c &lt;conf&gt;] [-V] [-v] [-h] &lt;package&gt; &lt;manager&gt;/&lt;distro&gt;...&quot;</span> &gt;&amp;2
	<span class="o">[</span> -n <span class="s2">&quot;$1&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span>
		<span class="nb">echo</span> <span class="s2">&quot;  -k, --keep               keep old versions of packages&quot;</span> &gt;&amp;2
		<span class="nb">echo</span> <span class="s2">&quot;  -c &lt;conf&gt;, --conf=&lt;conf&gt; config file to parse&quot;</span> &gt;&amp;2
		<span class="nb">echo</span> <span class="s2">&quot;  -V, --verbose            verbose mode&quot;</span> &gt;&amp;2
		<span class="nb">echo</span> <span class="s2">&quot;  -v, --version            show the program version&quot;</span> &gt;&amp;2
		<span class="nb">echo</span> <span class="s2">&quot;  -h, --help               show this help message&quot;</span> &gt;&amp;2
	<span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0 <span class="o">||</span> <span class="nb">exit </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>The first non-option argument is the package file.  The others are each
<code>&lt;manager&gt;/&lt;distro&gt;</code> paths for this package, which are listed in <code>$@</code>.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span>
<span class="k">do</span>
<span class="k">	case</span> <span class="s2">&quot;$1&quot;</span> in
		-k|--keep<span class="o">)</span>
			<span class="nv">KEEP</span><span class="o">=</span>1
			<span class="nb">shift</span>
			;;
		-V|--verbose<span class="o">)</span>
			<span class="nv">VERBOSE</span><span class="o">=</span>1
			<span class="nb">shift</span>
			;;
		-h|--help<span class="o">)</span>
			usage <span class="nb">help</span>
			;;
		-v|--version<span class="o">)</span>
			. version.sh
			<span class="nb">echo</span> <span class="s2">&quot;$VERSION&quot;</span>
			<span class="nb">exit </span>0
			;;
		-<span class="o">)</span>
			<span class="nb">echo</span> <span class="s2">&quot;# [freight] unknown switch: $1&quot;</span> &gt;&amp;2
			;;
		*<span class="o">)</span>
			<span class="nb">break</span>
			;;
	<span class="k">esac</span>
<span class="k">done</span>
. freight-setup

</pre></div></td></tr><tr><td class=docs>

<p>Create a working directory on the same device as the Freight library and
link or copy this package there.</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">PACKAGE</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
<span class="o">[</span> -z <span class="s2">&quot;$PACKAGE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> usage
<span class="nb">shift</span>
<span class="o">[</span> -z <span class="s2">&quot;$*&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> usage

</pre></div></td></tr><tr><td class=docs>

<p>Enter the Freight library directory so that items in <code>$@</code> may be given as
absolute paths or as partial paths of the form <code>&lt;manager&gt;/&lt;distro&gt;</code> that
are ultimately taken relative to the Freight library.</p>

</td><td class=code><div class=highlight><pre>
<span class="nv">TMP</span><span class="o">=</span><span class="s2">&quot;$(mktemp -d &quot;</span><span class="nv">$VARLIB</span>/work.<span class="nv">$$</span>.XXXXXXXXXX<span class="s2">&quot;)&quot;</span>
ln <span class="s2">&quot;$PACKAGE&quot;</span> <span class="s2">&quot;$TMP/$(basename $PACKAGE)&quot;</span> <span class="se">\</span>
	<span class="o">||</span> cp <span class="s2">&quot;$PACKAGE&quot;</span> <span class="s2">&quot;$TMP/$(basename $PACKAGE)&quot;</span>

</pre></div></td></tr><tr><td class=docs>

<p>Remove old versions of this package from every <code>&lt;manager&gt;/&lt;distro&gt;</code>
given in <code>$@</code> unless explicitly asked to keep them.
TODO Decouple this from <code>apt</code>-specific file naming conventions.</p>

</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> <span class="s2">&quot;$VARLIB&quot;</span>

</pre></div></td></tr><tr><td class=docs>

<p>Hard link this package into every <code>&lt;manager&gt;/&lt;distro&gt;</code> given in <code>$@</code>.
These links will later be used to compile the <code>Release</code> and <code>Packages</code>
files in the Freight cache.</p>

</td><td class=code><div class=highlight><pre>
. apt.sh
<span class="o">[</span> -z <span class="s2">&quot;$KEEP&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">for </span>DIR in <span class="s2">&quot;$@&quot;</span>
<span class="k">do</span>
<span class="k">	</span>find <span class="s2">&quot;$DIR&quot;</span> -name <span class="s2">&quot;$(apt_name $PACKAGE)_*_$(apt_arch $PACKAGE).deb&quot;</span> <span class="se">\</span>
		-delete 2&gt;/dev/null
<span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>

<p>This isn't strictly necessary but it's a nice habit to leave everything
as it was found.</p>

</td><td class=code><div class=highlight><pre>
<span class="k">for </span>DIR in <span class="s2">&quot;$@&quot;</span>
<span class="k">do</span>
<span class="k">	</span>mkdir -p <span class="s2">&quot;$DIR&quot;</span>
	ln <span class="s2">&quot;$TMP/$(basename $PACKAGE)&quot;</span> <span class="s2">&quot;$DIR/$(basename $PACKAGE)&quot;</span> 2&gt;/dev/null <span class="se">\</span>
		<span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;# [freight] $DIR already has $PACKAGE&quot;</span> &gt;&amp;2
<span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>

<p>Clean up the working directory.  Ultimately, this will just reduce the
link count of this package by one as it's linked elsewhere.</p>

</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> - &gt;/dev/null

</pre></div></td></tr><tr><td class=docs>

</td><td class=code><div class=highlight><pre>
rm -rf <span class="s2">&quot;$TMP&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
