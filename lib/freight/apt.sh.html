<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>apt.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>apt.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><p>Print the package name from the given package filename.</p>

</pre></div></td></tr><tr><td class=docs>

<p>Print the version from the given package filename.</p>

</td><td class=code><div class=highlight><pre>
apt_name<span class="o">()</span> <span class="o">{</span>
basename <span class="s2">&quot;$1&quot;</span> .deb | cut -d_ -f1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Print the architecture from the given package filename.</p>

</td><td class=code><div class=highlight><pre>
apt_version<span class="o">()</span> <span class="o">{</span>
	basename <span class="s2">&quot;$1&quot;</span> .deb | cut -d_ -f2
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Print the checksum portion of the normal checksumming programs' output.</p>

</td><td class=code><div class=highlight><pre>
apt_arch<span class="o">()</span> <span class="o">{</span>
	basename <span class="s2">&quot;$1&quot;</span> .deb | cut -d_ -f3
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

<p>Print the size of the given file.</p>

</td><td class=code><div class=highlight><pre>
apt_md5<span class="o">()</span> <span class="o">{</span>
	md5sum <span class="s2">&quot;$1&quot;</span> | cut -d<span class="s2">&quot; &quot;</span> -f1
<span class="o">}</span>
apt_sha1<span class="o">()</span> <span class="o">{</span>
	sha1sum <span class="s2">&quot;$1&quot;</span> | cut -d<span class="s2">&quot; &quot;</span> -f1
<span class="o">}</span>
apt_sha256<span class="o">()</span> <span class="o">{</span>
	sha256sum <span class="s2">&quot;$1&quot;</span> | cut -d<span class="s2">&quot; &quot;</span> -f1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>

</td><td class=code><div class=highlight><pre>
apt_filesize<span class="o">()</span> <span class="o">{</span>
	stat -c %s <span class="s2">&quot;$1&quot;</span>
<span class="o">}</span>

apt<span class="o">()</span> <span class="o">{</span>
	<span class="nv">DIST</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>

	<span class="c"># Generate a timestamp to use in this build&#39;s directory name.</span>
	<span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;$(date +%Y%m%d%H%M%S%N)&quot;</span>

	<span class="c"># For a Debian archive, each distribution needs at least this directory</span>
	<span class="c"># structure in place.  The directory for this build must not exist,</span>
	<span class="c"># otherwise this build would clobber a previous one.</span>
	mkdir -p <span class="s2">&quot;$VARCACHE/dists&quot;</span>
	mkdir <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE&quot;</span>
	mkdir -p <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main&quot;</span>
	mkdir -p <span class="s2">&quot;$VARCACHE/pool/main&quot;</span>

	<span class="c"># Do a preliminary read of the input and create all architecture-</span>
	<span class="c"># specific directories.  This will allow packages marked `all` to</span>
	<span class="c"># actually be placed in all architectures.</span>
	<span class="k">while </span><span class="nb">read </span>PACKAGE
	<span class="k">do</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;$PACKAGE&quot;</span>
		<span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;$(apt_arch &quot;</span><span class="nv">$PACKAGE</span><span class="s2">&quot;)&quot;</span>
		<span class="o">[</span> <span class="s2">&quot;$ARCH&quot;</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">		</span>mkdir -p <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH&quot;</span>
		touch <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH/Packages&quot;</span>
	<span class="k">done</span> &gt;<span class="s2">&quot;$TMP/packages&quot;</span>
	<span class="nv">ARCHS</span><span class="o">=</span><span class="s2">&quot;$(echo &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/main<span class="s2">&quot;/binary-* \</span>
<span class="s2">		| xargs -n1 basename | cut -d- -f2 | grep -v all)&quot;</span> <span class="c"># FIXME</span>
<span class="nb">echo</span> <span class="s2">&quot;ARCHS: $ARCHS&quot;</span>

	<span class="c"># Work through every package that should be part of this distro.</span>
	<span class="k">while </span><span class="nb">read </span>PACKAGE
	<span class="k">do</span>
<span class="nb">echo</span> <span class="s2">&quot;PACKAGE: $PACKAGE&quot;</span>

		<span class="c"># Link or copy this package into the pool.</span>
		<span class="c"># TODO Packages that start with `lib` should be in a `libX`</span>
		<span class="c"># directory.</span>
		<span class="nv">POOL</span><span class="o">=</span><span class="s2">&quot;pool/main/$(echo &quot;</span><span class="nv">$PACKAGE</span><span class="s2">&quot; | cut -c1)/$(apt_name &quot;</span><span class="nv">$PACKAGE</span><span class="s2">&quot;)&quot;</span>
		mkdir -p <span class="s2">&quot;$VARCACHE/$POOL&quot;</span>
		<span class="o">[</span> -f <span class="s2">&quot;$VARCACHE/$POOL/$PACKAGE&quot;</span> <span class="o">]</span> <span class="se">\</span>
			<span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;# [freight] pool already has $PACKAGE&quot;</span> &gt;&amp;2 <span class="se">\</span>
			<span class="o">||</span> ln <span class="s2">&quot;$VARLIB/apt/$DIST/$PACKAGE&quot;</span> <span class="s2">&quot;$VARCACHE/$POOL/$PACKAGE&quot;</span> <span class="se">\</span>
			<span class="o">||</span> cp <span class="s2">&quot;$VARLIB/apt/$DIST/$PACKAGE&quot;</span> <span class="s2">&quot;$VARCACHE/$POOL/$PACKAGE&quot;</span>

		<span class="c"># Build a list of the one-or-more `Packages` files to append with</span>
		<span class="c"># this package&#39;s info.</span>
		<span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;$(apt_arch &quot;</span><span class="nv">$PACKAGE</span><span class="s2">&quot;)&quot;</span>
		<span class="o">[</span> <span class="s2">&quot;$ARCH&quot;</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span> <span class="o">]</span> <span class="se">\</span>
			<span class="o">&amp;&amp;</span> <span class="nv">FILES</span><span class="o">=</span><span class="s2">&quot;$(find &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/main<span class="s2">&quot; -type f)&quot;</span> <span class="se">\</span>
			<span class="o">||</span> <span class="nv">FILES</span><span class="o">=</span><span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH/Packages&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;FILES: $FILES&quot;</span>

		<span class="c"># Grab and augment the control file from this package.  Remove</span>
		<span class="c"># `Size`, `MD5Sum`, etc. lines and replace them with newly</span>
		<span class="c"># generated values.  Add the `Filename` field containing the</span>
		<span class="c"># path to the package, starting with `pool/`.</span>
		dpkg-deb -e <span class="s2">&quot;$VARLIB/apt/$DIST/$PACKAGE&quot;</span> <span class="s2">&quot;$TMP/DEBIAN&quot;</span>
		<span class="o">{</span>
			cat <span class="s2">&quot;$TMP/DEBIAN/control&quot;</span> <span class="se">\</span>
				| grep -v <span class="s2">&quot;^(Essential|Filename|MD5Sum|SHA1|SHA256|Size)&quot;</span>
			cat <span class="s">&lt;&lt;EOF</span>
<span class="s">Filename: $POOL/$PACKAGE</span>
<span class="s">MD5Sum: $(apt_md5 &quot;$VARLIB/apt/$DIST/$PACKAGE&quot;)</span>
<span class="s">SHA1: $(apt_sha1 &quot;$VARLIB/apt/$DIST/$PACKAGE&quot;)</span>
<span class="s">SHA256: $(apt_sha256 &quot;$VARLIB/apt/$DIST/$PACKAGE&quot;)</span>
<span class="s">Size: $(apt_filesize &quot;$VARLIB/apt/$DIST/$PACKAGE&quot;)</span>
<span class="s">EOF</span>
			<span class="nb">echo</span>
		<span class="o">}</span> | tee -a <span class="nv">$FILES</span> &gt;/dev/null
		rm -rf <span class="s2">&quot;$TMP/DEBIAN&quot;</span>

	<span class="k">done</span> &lt;<span class="s2">&quot;$TMP/packages&quot;</span>

	<span class="c"># Build a `Release` file for each architecture.  `gzip` the `Packages`</span>
	<span class="c"># file, too.</span>
	<span class="k">for </span>ARCH in <span class="nv">$ARCHS</span>
	<span class="k">do</span>
<span class="k">		</span>cat &gt;<span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH/Release&quot;</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">Archive: $DIST</span>
<span class="s">Component: main</span>
<span class="s">Origin: $ORIGIN</span>
<span class="s">Label: $LABEL</span>
<span class="s">Architecture: $ARCH</span>
<span class="s">EOF</span>
		gzip -c <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH/Packages&quot;</span> <span class="se">\</span>
			&gt;<span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main/binary-$ARCH/Packages.gz&quot;</span>
	<span class="k">done</span>

	<span class="c"># Begin the top-level `Release` file with the lists of components</span>
	<span class="c"># and architectures present in this repository and the checksums</span>
	<span class="c"># of all the `Release` and `Packages.gz` files within.</span>
	<span class="o">{</span>
		cat <span class="s">&lt;&lt;EOF</span>
<span class="s">Origin: $ORIGIN</span>
<span class="s">Label: $LABEL</span>
<span class="s">Codename: $DIST</span>
<span class="s">Components: main</span>
<span class="s">Architectures: $ARCHS</span>
<span class="s">EOF</span>

		<span class="c"># Finish the top-level `Release` file with references and</span>
		<span class="c"># checksums for each sub-`Release` file and `Packages.gz` file.</span>
		<span class="c"># In the future, `Sources` may find a place here, too.</span>
		find <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/main&quot;</span> -type f -printf main/%P<span class="se">\\</span>n <span class="se">\</span>
			| <span class="k">while </span><span class="nb">read </span>FILE
		<span class="k">do</span>
<span class="k">			</span><span class="nv">SIZE</span><span class="o">=</span><span class="s2">&quot;$(apt_filesize &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/<span class="nv">$FILE</span><span class="s2">&quot;)&quot;</span>
			<span class="nb">echo</span> <span class="s2">&quot; $(apt_md5 &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/<span class="nv">$FILE</span><span class="s2">&quot; \</span>
<span class="s2">				) $SIZE $FILE&quot;</span> &gt;&amp;3
			<span class="nb">echo</span> <span class="s2">&quot; $(apt_sha1 &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/<span class="nv">$FILE</span><span class="s2">&quot; \</span>
<span class="s2">				) $SIZE $FILE&quot;</span> &gt;&amp;4
			<span class="nb">echo</span> <span class="s2">&quot; $(apt_sha256 &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span>-<span class="nv">$DATE</span>/<span class="nv">$FILE</span><span class="s2">&quot; \</span>
<span class="s2">				) $SIZE $FILE&quot;</span> &gt;&amp;5
		<span class="k">done </span>3&gt;<span class="s2">&quot;$TMP/md5sums&quot;</span> 4&gt;<span class="s2">&quot;$TMP/sha1sums&quot;</span> 5&gt;<span class="s2">&quot;$TMP/sha256sums&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;MD5Sum:&quot;</span>
		cat <span class="s2">&quot;$TMP/md5sums&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;SHA1Sum:&quot;</span>
		cat <span class="s2">&quot;$TMP/sha1sums&quot;</span>
		<span class="nb">echo</span> <span class="s2">&quot;SHA256Sum:&quot;</span>
		cat <span class="s2">&quot;$TMP/sha256sums&quot;</span>

	<span class="o">}</span> &gt;<span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/Release&quot;</span>

	<span class="c"># Sign the top-level `Release` file with `gpg`.</span>
	gpg -sbao <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/Release.gpg&quot;</span> <span class="se">\</span>
		<span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE/Release&quot;</span>
	<span class="o">[</span> -f <span class="s2">&quot;$VARCACHE/keyring.gpg&quot;</span> <span class="o">]</span> <span class="se">\</span>
		<span class="o">||</span> gpg --export -a <span class="s2">&quot;$GPG&quot;</span> &gt;<span class="s2">&quot;$VARCACHE/keyring.gpg&quot;</span>

	<span class="c"># Move the symbolic link for this distro to this build.</span>
	ln -s <span class="s2">&quot;$DIST-$DATE&quot;</span> <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE-&quot;</span>
	<span class="nv">OLD</span><span class="o">=</span><span class="s2">&quot;$(readlink &quot;</span><span class="nv">$VARCACHE</span>/dists/<span class="nv">$DIST</span><span class="s2">&quot; || true)&quot;</span>
	mv -T <span class="s2">&quot;$VARCACHE/dists/$DIST-$DATE-&quot;</span> <span class="s2">&quot;$VARCACHE/dists/$DIST&quot;</span>
	<span class="o">[</span> -z <span class="s2">&quot;$OLD&quot;</span> <span class="o">]</span> <span class="o">||</span> rm -rf <span class="s2">&quot;$VARCACHE/dists/$OLD&quot;</span>

	<span class="c"># TODO Remove links from the pool that are no longer needed.</span>

<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
